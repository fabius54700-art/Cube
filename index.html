<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <script src="https://cdn.jsdelivr.net/npm/@jaames/iro@5"></script>
    <title>Hiboux Funky Sync</title>
    <style>
        :root { --bg: #121212; --card: #1e1e1e; --accent: #007aff; --text: #ffffff; --success: #34c759; --danger: #ff3b30; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); color: var(--text); padding: 20px; display: flex; flex-direction: column; align-items: center; }
        .card { background: var(--card); padding: 20px; border-radius: 25px; width: 100%; max-width: 350px; margin-bottom: 20px; transition: 0.3s; }
        .locked { opacity: 0.2; pointer-events: none; filter: grayscale(1); }
        .btn { width: 100%; padding: 15px; border-radius: 15px; border: none; font-weight: bold; cursor: pointer; margin-bottom: 10px; }
        #status-badge { font-size: 10px; opacity: 0.5; margin-bottom: 10px; text-transform: uppercase; }
        input[type="range"] { width: 100%; margin: 20px 0; }
        select { width: 100%; padding: 12px; border-radius: 10px; background: #333; color: white; border: none; }
        .hidden { display: none; }
    </style>
</head>
<body>

    <div id="status-badge">PrÃªt Ã  connecter</div>
    <button id="connectBtn" class="btn" style="background:var(--success); color:white;">Connecter mon Hiboux ðŸ”Œ</button>

    <div id="controls" class="locked">
        <div class="card">
            <button id="pwrBtn" class="btn">Chargement...</button>
            <div id="picker" style="display:flex; justify-content:center; margin:20px 0;"></div>
            <input type="range" id="briSlider" min="13" max="255">
        </div>

        <div class="card">
            <span style="font-size:12px; color:#888;">AMBIANCE</span>
            <select id="modeSelect">
                <option value="0">Statique</option>
                <option value="2">ðŸŒˆ Arc-en-ciel</option>
                <option value="3">ðŸ’“ Respiration</option>
            </select>
        </div>
    </div>

    <script>
        const SRV_UUID = "6e400008-b5a3-f393-e0a9-e50e24dcca9e";
        const CHR_UUID = "6e400009-b5a3-f393-e0a9-e50e24dcca9e";
        let char, isOn = false;

        var colorPicker = new iro.ColorPicker("#picker", { width: 220, layout: [{ component: iro.ui.Wheel }] });

        // Envoi des donnÃ©es vers la lampe
        async function send(data) { if(char) await char.writeValue(new Uint8Array(data)); }

        colorPicker.on('color:change', (color) => {
            if (Date.now() - lastSend > 100) {
                send([88, color.rgb.r, color.rgb.g, color.rgb.b]);
                lastSend = Date.now();
            }
        });
        let lastSend = 0;

        // --- CONNEXION ET SYNCHRO ---
        document.getElementById('connectBtn').onclick = async () => {
            const device = await navigator.bluetooth.requestDevice({ 
                filters: [{ name: 'Hiboux_Funky' }], 
                optionalServices: [SRV_UUID] 
            });
            const server = await device.gatt.connect();
            const service = await server.getPrimaryService(SRV_UUID);
            char = await service.getCharacteristic(CHR_UUID);

            // 1. Ã‰couter les notifications de la lampe
            await char.startNotifications();
            char.addEventListener('characteristicvaluechanged', (e) => {
                const d = e.target.value;
                // Update UI sans renvoyer d'ordres
                isOn = d.getUint8(0) === 1;
                document.getElementById('briSlider').value = d.getUint8(1);
                document.getElementById('modeSelect').value = d.getUint8(2);
                colorPicker.color.set({r: d.getUint8(3), g: d.getUint8(4), b: d.getUint8(5)});
                updateUI();
            });

            // 2. DÃ©bloquer et demander l'Ã©tat actuel
            document.getElementById('controls').classList.remove('locked');
            document.getElementById('connectBtn').classList.add('hidden');
            document.getElementById('status-badge').innerText = "ConnectÃ© âœ…";
            send([81]); // Code 'Q' pour Query
        };

        function updateUI() {
            const b = document.getElementById('pwrBtn');
            b.innerText = isOn ? "ALLUMÃ‰" : "Ã‰TEINT";
            b.style.background = isOn ? "#3a3a3c" : "#222";
            b.style.border = isOn ? "2px solid var(--success)" : "2px solid var(--danger)";
        }

        document.getElementById('pwrBtn').onclick = () => { isOn = !isOn; send([80, isOn?1:0]); updateUI(); };
        document.getElementById('briSlider').oninput = (e) => send([66, e.target.value]);
        document.getElementById('modeSelect').onchange = (e) => send([69, e.target.value]);
    </script>
</body>
</html>
