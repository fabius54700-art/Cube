<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <script src="https://cdn.jsdelivr.net/npm/@jaames/iro@5"></script>
    <title>Hiboux Funky</title>
    <style>
        :root { --bg: #121212; --card: #1e1e1e; --accent: #007aff; --danger: #ff3b30; --success: #34c759; --text: #ffffff; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); color: var(--text); margin: 0; display: flex; flex-direction: column; align-items: center; padding: 20px; box-sizing: border-box; }
        .container { width: 100%; max-width: 400px; text-align: center; }
        h1 { font-weight: 200; letter-spacing: 4px; text-transform: uppercase; margin: 20px 0; font-size: 1.2rem; }
        #connectBtn { background: var(--success); color: white; border: none; padding: 12px 25px; border-radius: 50px; font-weight: bold; cursor: pointer; margin-bottom: 20px; }
        .card { background: var(--card); padding: 20px; border-radius: 25px; border: 1px solid rgba(255,255,255,0.05); margin-bottom: 20px; }
        #controls-container { transition: 0.5s; }
        .locked { opacity: 0.1; pointer-events: none; filter: grayscale(1); }
        .btn { width: 100%; padding: 15px; border-radius: 15px; border: none; font-weight: bold; cursor: pointer; margin-bottom: 10px; color: white; background: #3a3a3c; }
        #pwrBtn.on { border: 2px solid var(--success); }
        
        input[type="range"] { width: 100%; margin: 20px 0; }
        select { width: 100%; padding: 12px; border-radius: 10px; background: #333; color: white; border: none; text-align: center; font-size: 1rem; outline: none; }
        #picker { display: flex; justify-content: center; margin: 15px 0; }
        
        /* AJOUT : Presets & Options */
        .grid { display: flex; justify-content: center; gap: 10px; margin: 10px 0 20px 0; flex-wrap: wrap; }
        .dot { width: 35px; height: 35px; border-radius: 50%; border: 2px solid rgba(255,255,255,0.1); cursor: pointer; transition: 0.2s; }
        .dot:active { transform: scale(0.9); }
        .switch-row { display: flex; align-items: center; justify-content: space-between; margin: 15px 0; font-size: 0.9rem; }
        .hint-text { color: #666; font-size: 11px; margin-top: 8px; text-align: left; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Hiboux Funky</h1>
        <button id="connectBtn">Connecter mon Hiboux ðŸ”Œ</button>
        
        <div id="controls-container" class="locked">
            <div class="card">
                <button id="pwrBtn" class="btn">Chargement...</button>
                <div id="picker"></div>
                
                <div class="grid" id="presetContainer"></div>
                
                <input type="range" id="briSlider" min="13" max="255">
            </div>

            <div class="card">
                <select id="modeSelect">
                    <option value="0">Statique (Couleur)</option>
                    <option value="2">ðŸŒˆ Arc-en-ciel Zen</option>
                    <option value="3">ðŸ’“ Respiration</option>
                    <option value="4">ðŸ”¥ Feu de cheminÃ©e</option>
                    <option value="5">ðŸŒŠ OcÃ©an</option>
                    <option value="6">ðŸŒ² ForÃªt Magique</option>
                    <option value="7">âœ¨ Disco Chill</option>
                </select>
                <div class="hint-text">Note : Changer la couleur repasse la lampe en mode statique.</div>
            </div>

            <div class="card">
                <div class="switch-row">
                    <span>Mode Pipi (Vibration)</span>
                    <input type="checkbox" id="vibToggle" checked>
                </div>
                <hr style="border:0; border-top:1px solid rgba(255,255,255,0.05); margin:15px 0;">
                <div style="display:flex; gap:10px; align-items: center;">
                    <select id="timerVal" style="flex:1;">
                        <option value="10">Test (10s)</option>
                        <option value="900">15 min</option>
                        <option value="1800" selected>30 min</option>
                        <option value="3600">1h</option>
                    </select>
                    <button id="timerBtn" class="btn" style="flex:1; margin:0; background:var(--accent);">Lancer Timer</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const SRV_UUID = "6e400008-b5a3-f393-e0a9-e50e24dcca9e";
        const CHR_UUID = "6e400009-b5a3-f393-e0a9-e50e24dcca9e";
        let char, isOn = false, lastSend = 0, isSyncing = false;

        // Init iro.js avec ton rÃ©glage
        var colorPicker = new iro.ColorPicker("#picker", { width: 250, color: "#fff", layout: [{ component: iro.ui.Wheel }] });

        // GÃ©nÃ©ration des presets
        const presets = ["#FF0000", "#00FF00", "#0096FF", "#FFFF00", "#A020F0", "#FFFFFF", "#FF6432"];
        const presetGrid = document.getElementById('presetContainer');
        presets.forEach((c, i) => {
            let dot = document.createElement('div');
            dot.className = 'dot';
            dot.style.background = c;
            dot.onclick = () => { if(!isSyncing) send([67, i]); };
            presetGrid.appendChild(dot);
        });

        async function send(data) { 
            if(char && !isSyncing) {
                try { await char.writeValue(new Uint8Array(data)); } catch(e){ console.log("Erreur d'envoi", e); } 
            }
        }

        colorPicker.on('color:change', (color) => {
            if(isSyncing) return;
            const now = Date.now();
            if(now - lastSend > 100) {
                send([88, color.rgb.r, color.rgb.g, color.rgb.b]);
                lastSend = now;
            }
        });

        document.getElementById('connectBtn').onclick = async () => {
            try {
                const device = await navigator.bluetooth.requestDevice({ filters: [{ name: 'Hiboux_Funky' }], optionalServices: [SRV_UUID] });
                const server = await device.gatt.connect();
                const service = await server.getPrimaryService(SRV_UUID);
                char = await service.getCharacteristic(CHR_UUID);

                await char.startNotifications();
                char.addEventListener('characteristicvaluechanged', (e) => {
                    const d = e.target.value;
                    if (d.byteLength < 6) return;
                    
                    isSyncing = true;
                    isOn = d.getUint8(0) === 1;
                    document.getElementById('briSlider').value = d.getUint8(1);
                    document.getElementById('modeSelect').value = d.getUint8(2);
                    
                    // Mise Ã  jour de la roue sans dÃ©clencher color:change
                    colorPicker.color.set({r: d.getUint8(3), g: d.getUint8(4), b: d.getUint8(5)});
                    
                    updateUI();
                    setTimeout(() => { isSyncing = false; }, 150);
                });

                document.getElementById('controls-container').classList.remove('locked');
                document.getElementById('connectBtn').style.display = 'none';
                
                // Demande d'Ã©tat (Query)
                setTimeout(() => { send([81]); }, 500); 

            } catch(e) { alert("Erreur de connexion : " + e); }
        };

        function updateUI() {
            const b = document.getElementById('pwrBtn');
            b.innerText = isOn ? "Lampe AllumÃ©e" : "Lampe Ã‰teinte";
            b.className = isOn ? "btn on" : "btn";
            b.style.borderColor = isOn ? "var(--success)" : "transparent";
        }

        // Events controls
        document.getElementById('pwrBtn').onclick = () => { isOn = !isOn; send([80, isOn?1:0]); updateUI(); };
        document.getElementById('briSlider').oninput = (e) => send([66, e.target.value]);
        document.getElementById('modeSelect').onchange = (e) => send([69, e.target.value]);
        document.getElementById('vibToggle').onchange = (e) => send([86, e.target.checked ? 1 : 0]);
        document.getElementById('timerBtn').onclick = () => {
            let val = parseInt(document.getElementById('timerVal').value);
            send([84, (val >> 8) & 0xFF, val & 0xFF]); // Envoi durÃ©e (2 bytes)
            setTimeout(() => send([83, 1]), 100); // Activation
        };
    </script>
</body>
</html>
